<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Tasman Traverse</title>
    <meta name="description" content="A virtual race across the Tasman Sea" />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src='csv2geojson.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
    <link href='skeleton.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:20%; width:100%; }
        #legend { position:absolute; top:80%; bottom:0; width:100%; }
    </style>
</head>
<body>
<div id='map'></div>
<div id='legend'>
  <div class="container" style="background: #172B4D; color: #fff;">
    <div class="row">
      <div class="twelve columns">
        <table class="u-full-width">
          <thead>
            <tr>
              <th>Rank</th>
              <th>name</th>
              <th>Distance from start</th>
              <th>Distance from finish</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY2xhcmtjYXJ0ZXIiLCJhIjoiY2p0MHpnaXBmMDNxNDQ5cGd5dXk2Mzh5eCJ9.Pqxx2YDY44GbuMmlIt1t-g';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/clarkcarter/cjt47ckbc3f8u1fmrox7uilg9', //stylesheet location
    center: [ 161.790582, -36.213924
], // starting position
    zoom: 2.94 // starting zoom
});

var dataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJHEq3YOJbEbwTR7xVuOJWoehmZAN7b0pwWXQ3kBYMm8S0VB0BVTkyyoYw52onHySJmQkmLE74EAvp/pub?gid=577896986&single=true&output=csv";

$(document).ready(function() {
    $.ajax({
        type: "GET",
        url: dataUrl,
        dataType: "text",
        success: function(csvData) {makeGeoJSON(csvData);}
     });
});

  function makeGeoJSON(csvData) {
    csv2geojson.csv2geojson(csvData, {
      latfield: 'latitude',
      lonfield: 'longitude',
      delimiter: ','
    }, function(err, data) {

      map.once('idle', function () {

        var clarkColor = "#0000ff";
        var danColor = "#181414";
        var julienColor = "#0e602d";
        var mattColor = "#129f31";
        var mickColor = "#eedd39";
        var ryanColor = "#f4f2bf";
        var troodlesColor = "#ffff00";

        map.addLayer({
                "id": "Clark",
                "type": "circle",
                "source": {
                  'type': 'geojson',
                  'data': data
                },
                "paint": {
                    "circle-radius": 6,
                    "circle-color": clarkColor
                },
                "filter": ["==", "name", "Clark"],
            });
            map.addLayer({
                    "id": "Dan",
                    "type": "circle",
                    "source": {
                      'type': 'geojson',
                      'data': data
                    },
                    "paint": {
                        "circle-radius": 6,
                        "circle-color": danColor
                    },
                    "filter": ["==", "name", "Dan"],
                });
            map.addLayer({
                    "id": "Julien",
                    "type": "circle",
                    "source": {
                      'type': 'geojson',
                      'data': data
                    },
                    "paint": {
                        "circle-radius": 6,
                        "circle-color": julienColor
                    },
                    "filter": ["==", "name", "Julien"],
                });
            map.addLayer({
                    "id": "Matt",
                    "type": "circle",
                    "source": {
                      'type': 'geojson',
                      'data': data
                    },
                    "paint": {
                        "circle-radius": 6,
                        "circle-color": mattColor
                    },
                    "filter": ["==", "name", "Matt"],
                });
            map.addLayer({
                    "id": "Mick",
                    "type": "circle",
                    "source": {
                      'type': 'geojson',
                      'data': data
                    },
                    "paint": {
                        "circle-radius": 6,
                        "circle-color": mickColor
                    },
                    "filter": ["==", "name", "Mick"],
                });
            map.addLayer({
                    "id": "Ryan",
                    "type": "circle",
                    "source": {
                      'type': 'geojson',
                      'data': data
                    },
                    "paint": {
                        "circle-radius": 6,
                        "circle-color": ryanColor
                    },
                    "filter": ["==", "name", "Ryan"],
                });
            map.addLayer({
                    "id": "Troodles",
                    "type": "circle",
                    "source": {
                      'type': 'geojson',
                      'data': data
                    },
                    "paint": {
                        "circle-radius": 6,
                        "circle-color": troodlesColor
                    },
                    "filter": ["==", "name", "Troodles"],
                });

        // add labels to each circle
         map.addLayer({
          'id': 'participants',
          'type': 'symbol',
          'source': {
          'type': 'geojson',
          'data': data
        },
          'layout': {
          //"icon-image": "{icon}-15",
          "text-field": "{name}",
          "text-font": ["Open Sans Regular", "Arial Unicode MS Bold"],
          "text-offset": [0, 0.6],
          "text-anchor": "top",
          "text-size": 12,
          "text-allow-overlap": false
          },
          'paint': {

          }
        });

        window.setTimeout(function() {
          var bounds = new mapboxgl.LngLatBounds();
          data.features.forEach(function(feature) {
          bounds.extend(feature.geometry.coordinates);
          });
          map.fitBounds(bounds, {
            padding: 100,
            speed: 0.2 });
        }, 3000);
      });

    console.log(data);
});
}


</script>

</body>
