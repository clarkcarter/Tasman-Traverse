<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Tasman Traverse</title>
    <meta name="description" content="A virtual race across the Tasman Sea" />
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src='csv2geojson.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
    <link href='skeleton.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; left:0; width:100%; }
    </style>
</head>
<body>
<style>
  .mapboxgl-popup {
  max-width: 400px;
  font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
  }
</style>

<div id='map'></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY2xhcmtjYXJ0ZXIiLCJhIjoiY2p0MHpnaXBmMDNxNDQ5cGd5dXk2Mzh5eCJ9.Pqxx2YDY44GbuMmlIt1t-g';
var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/clarkcarter/cjt47ckbc3f8u1fmrox7uilg9', //stylesheet location
    center: [ 161.790582, -36.213924
], // starting position
    zoom: 2.94 // starting zoom
});

var dataUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJHEq3YOJbEbwTR7xVuOJWoehmZAN7b0pwWXQ3kBYMm8S0VB0BVTkyyoYw52onHySJmQkmLE74EAvp/pub?gid=577896986&single=true&output=csv";

$(document).ready(function() {
    $.ajax({
        type: "GET",
        url: dataUrl,
        dataType: "text",
        success: function(csvData) {makeGeoJSON(csvData);}
     });
});

  function makeGeoJSON(csvData) {
    csv2geojson.csv2geojson(csvData, {
      latfield: 'latitude',
      lonfield: 'longitude',
      delimiter: ','
    }, function(err, data) {

      map.once('idle', function () {

        map.addLayer({
          "id": "participants",
          "type": "circle",
          "source": {
            'type': 'geojson',
            'data': data
          },
          'layout': {
          "text-field": "{name}",
          "text-font": ["Open Sans Regular", "Arial Unicode MS Bold"],
          "text-offset": [0, 0.6],
          "text-anchor": "top",
          "text-size": 12,
          "text-allow-overlap": false
          },
          "paint": {
            "circle-radius": 6,
            "circle-color": { type: "identity", property: "color" }
          }
        });


        // add labels to each circle
        map.addLayer({
          'id': 'names',
          'type': 'symbol',
          'source': {
          'type': 'geojson',
          'data': data
        },
          'layout': {
          //"icon-image": "{icon}-15",
          "text-field": "{name}",
          "text-font": ["Open Sans Regular", "Arial Unicode MS Bold"],
          "text-offset": [0, 0.6],
          "text-anchor": "top",
          "text-size": 12,
          "text-allow-overlap": false
          }
        });

        // Create a popup, but don't add it to the map yet.
        var popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false
        });

        map.on('mouseenter', 'participants', function(e) {
        // Change the cursor style as a UI indicator.
          map.getCanvas().style.cursor = 'pointer';

          var coordinates = e.features[0].geometry.coordinates.slice();
          var name = e.features[0].properties.name;

          // Ensure that if the map is zoomed out such that multiple
          // copies of the feature are visible, the popup appears
          // over the copy being pointed to.
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }

          // Populate the popup and set its coordinates
          // based on the feature found.
          popup.setLngLat(coordinates)
            .setHTML(name)
            .addTo(map);
        });

        map.on('mouseleave', 'participants', function() {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

        window.setTimeout(function() {
          var bounds = new mapboxgl.LngLatBounds();
          data.features.forEach(function(feature) {
          bounds.extend(feature.geometry.coordinates);
          });
          map.fitBounds(bounds, {
            padding: 100,
            speed: 0.2 });
        }, 3000);
      });

    console.log(data);
});
}


</script>

</body>
